<?php
// PrintTickets RadiusMonitor By Maizil
include "phpqrcode/qrlib.php";
$cs = "CS : 0853-7268-7484";
$dnsname = "http://mutiara.net";

$configValues = array(
    "CONFIG_DB_TBL_DALOBILLINGPLANS" => "billing_plans",
    "CONFIG_DB_TBL_RADGROUPREPLY" => "radgroupreply",
    "CONFIG_DB_TBL_RADGROUPCHECK" => "radgroupcheck" 
);

if (isset($_REQUEST["type"]) && $_REQUEST["type"] == "batch") {
    if (isset($_REQUEST['format'])) {
        $format = $_REQUEST['format'];

    } else {
        
    }

    $plan = $_REQUEST["plan"];
    $accounts_temp = $_REQUEST["accounts"];
    $accounts = explode("||", $accounts_temp);

    // Konfigurasi database
    $host = '127.0.0.1';
    $dbname = 'radius';
    $username = 'radius';
    $password = 'radius';

        $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        $sql = "SELECT planCost, planTimeBank, planCurrency FROM " . $configValues["CONFIG_DB_TBL_DALOBILLINGPLANS"] . " WHERE planName = :plan";
        $stmt = $pdo->prepare($sql);
        $stmt->bindParam(':plan', $plan, PDO::PARAM_STR);
        $stmt->execute();

        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($row) {
            $ticketCurrency = $row["planCurrency"];
            $ticketCost = $row["planCost"] . " " . $ticketCurrency;
            $ticketTime = time2str($row["planTimeBank"]);
            
        } else {
        $ticketCurrency = '0';
        $ticketCost = '0';
        $ticketTime = '';
        }

            $sqlQuota = "SELECT value FROM " . $configValues["CONFIG_DB_TBL_RADGROUPREPLY"] . " WHERE groupname = :plan AND attribute = 'ChilliSpot-Max-Total-Octets'";
            $stmtQuota = $pdo->prepare($sqlQuota);
            $stmtQuota->bindParam(':plan', $plan, PDO::PARAM_STR);
            $stmtQuota->execute();

            $quotaRow = $stmtQuota->fetch(PDO::FETCH_ASSOC);
            $ticketQuota = isset($quotaRow["value"]) ? formatBytes($quotaRow["value"]) : "";

            $sqlActiveTime = "SELECT value FROM " . $configValues["CONFIG_DB_TBL_RADGROUPCHECK"] . " WHERE groupname = :plan AND attribute = 'Max-All-Session'";
            $stmtActiveTime = $pdo->prepare($sqlActiveTime);
            $stmtActiveTime->bindParam(':plan', $plan, PDO::PARAM_STR);
            $stmtActiveTime->execute();

            $activeRow = $stmtActiveTime->fetch(PDO::FETCH_ASSOC);
            $ticketActiveTime = isset($activeRow["value"]) ? time2str($activeRow["value"]) : "";

            $timestamp = date('Y-m-d H:i:s');

            printTicketsHTMLTable($accounts, $ticketCost, $ticketTime, $ticketQuota, $ticketActiveTime, $timestamp);

}

function formatBytes($bytes, $decimal = 0) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB');
    $factor = floor((strlen($bytes) - 1) / 3);
    return sprintf("%." . $decimal . "f", $bytes / pow(1024, $factor)) . ' ' . $units[$factor];
}

function time2str($time) {
    if (!is_numeric($time)) {
        return '';
    }
    $units = array(
        "TAHUN" => 365*24*3600,
        "BULAN" => 30*24*3600,
        "HARI" => 24*3600,
        "JAM" => 3600,
        "MENIT" => 60,
        "DETIK" => 1,
    );

    $str = "";
    foreach ($units as $name => $divisor) {
        $quot = intval($time / $divisor);
        if ($quot) {
            $str .= "$quot $name ";
            $time -= $quot * $divisor;
        }
    }

    return trim($str);
}

function printTicketsHTMLTable($accounts, $ticketCost, $ticketTime, $ticketQuota, $ticketActiveTime, $timestamp)
{
    global $dnsname, $cs;

    if ($ticketCost <= 500) {
        $color = "#4bde97";
    } elseif ($ticketCost >= 1000 && $ticketCost <= 4000) {
        $color = "#e83e8c";
    } elseif ($ticketCost >= 4000 && $ticketCost <= 24000) {
        $color = "#f74e07";
    } elseif ($ticketCost >= 25000 && $ticketCost <= 49000) {
        $color = "#0f8d43";
    } elseif ($ticketCost >= 50000 && $ticketCost <= 100000) {
        $color = "#9911b1";
    }

    array_shift($accounts);
    foreach ($accounts as $userpass) {
        list($user, $pass) = explode(",", $userpass);

        $size = isset($_REQUEST["size"]) ? (int)$_REQUEST["size"] : 5;
        $matrixPointSize = min(max($size, 5), 10);

?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $timestamp; ?></title>
    <link rel="icon" href="assets/img/favicon.png">
    <script src="assets/js/jquery.min.js"></script>
    <style>
        body {
            color: #000;
            background-color: #FFF;
            font-size: 14px;
            font-family: 'Helvetica', Arial, sans-serif;
            margin: 0;
            -webkit-print-color-adjust: exact;
            justify-content: center;
            align-items: center;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            width: 100%;
        }

        table.voucher {
            border: 2px solid black;
            margin: 2px;
            width: 180px;
            margin-bottom: 10px;
        }

        @page {
            size: auto;
            margin: 7mm 3mm 3mm 7mm;
        }

        @media print {
            table { page-break-after: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            td { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
        }

        .qrcode {
            height: 100px;
            width: 100px;
        }

        .price {
            font-size: 20px;
        }

        .header-title {
            text-align: center;
            font-size: 14px;
            border-bottom: 1px solid black;
        }

        .header-title span {
            font-size: 20px;
            font-weight: bold;
        }

        .user-info, .price-info, .footer-info {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            border-top: 1px solid black;
        }

        .footer-info {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <table class="voucher">
            <tbody>
                <tr>
                    <td class="header-title">
                        <center><span>ùó†ùó®ùóßùóúùóîùó•ùóî.<span style="color:<?php echo $color; ?>;">ùó°ùóòùóß</span></center>
                        <center><?php echo $timestamp; ?>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table style="width: 100%; font-size: 12px;">
                            <tbody>
                                <tr>
                                    <td><center>Username</td>
                                    <?php if ($pass !== "Accept"): ?>
                                        <td>Password</td>
                                    <?php endif; ?>
                                </tr>
                                <tr style="font-size: 14px;">
                                    <td style="border: 1px solid black;"><center><?php echo $user; ?></td>
                                    <?php if ($pass !== "Accept"): ?>
                                        <td style="border: 1px solid black;"><center><?php echo $pass; ?></td>
                                    <?php endif; ?>
                                </tr>
                                <tr class="user-info">
                                    <td colspan="2"><center><?php echo $ticketActiveTime; ?> <?php echo $ticketTime; ?> <?php echo $ticketQuota; ?></td>
                                </tr>
                                <tr class="price-info">
                                    <td colspan="2"><center>Rp <?php echo $ticketCost; ?></td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                            <?php
                                $tempdir = "tmp/";

                                    if (!file_exists($tempdir)) {
                                        mkdir($tempdir);}
                                        
                                            $qrcodeData = "http://10.10.10.1:3990/login?username=" . urlencode($user) . "&password=" . urlencode($pass);

                                            $errorCorrectionLevel = 'L';

                                            $matrixPointSize = min(max((int)($_REQUEST['size'] ?? 10), 2), 5);

                                            $qrcodeFilename = $tempdir . $user . '.png';

                                            QRcode::png($qrcodeData, $qrcodeFilename, $errorCorrectionLevel, $matrixPointSize, 2);

                                            echo '<center><img src="' . htmlspecialchars($qrcodeFilename) . '" alt="QR Code">';
                                        ?>
                                    <td>
						        </tr>
						    <tr>
							<td colspan="2" style="font-weight:bold; font-size:12px"><center>Login: <?php echo $dnsname;?></td>
						</tr>
					</tbody>
				</table>
			</td>
		</tr>
	</tbody>
</table>
</body>
</html>
<?php
    }
}
?>
